<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>繰り返し予定付きカレンダー</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      font-size: 1.5rem;
      margin: 1rem 0;
    }
    #controls {
      margin: 10px;
    }
    button, input[type="text"] {
      padding: 6px 10px;
      font-size: 1rem;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #888;
    }
    #calendar {
      width: 100%;
      max-width: 700px;
      margin: auto;
      padding: 0 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      width: 14.28%;
      border: 1px solid #ccc;
      vertical-align: top;
      padding: 4px;
      font-size: 0.75rem;
      height: 100px;
      position: relative;
      box-sizing: border-box;
    }
    th {
      background-color: #f0f0f0;
    }
    td {
      cursor: pointer;
    }
    td.today {
      background-color: #ffeeba;
    }
    td.sunday {
      background-color: #ffe5e5;
    }
    td.saturday {
      background-color: #e5f0ff;
    }
    .event {
      font-size: 0.7rem;
      background: #e0f7fa;
      margin-top: 4px;
      padding: 2px 4px;
      border-radius: 4px;
      word-break: break-word;
      text-align: left;
    }
    .recurring {
      background-color: #dcedc8;
    }
    #instructions {
      position: fixed;
      right: 10px;
      bottom: 10px;
      font-size: 0.7rem;
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 6px;
      max-width: 200px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      th, td {
        font-size: 0.7rem;
        height: 80px;
      }
      .event {
        font-size: 0.65rem;
      }
    }
  </style>
</head>
<body>
  <h1 id="monthYear"></h1>
  <div id="controls">
    <button onclick="prevMonth()">← 前の月</button>
    <button onclick="nextMonth()">次の月 →</button><br>
    <input type="text" id="searchBox" placeholder="予定を検索..." oninput="renderCalendar()">
    <button onclick="clearSearch()">検索クリア</button>
  </div>
  <div id="calendar"></div>
  <div id="instructions">
    📌 <strong>操作説明</strong><br>
    ・日付クリック → 予定追加<br>
    ・予定クリック → 編集 / 削除<br>
    ・検索欄 → 予定を絞り込み表示<br>
    ・曜日チェック → 繰り返し予定
  </div>
  <script>
    const calendar = document.getElementById("calendar");
    const monthYear = document.getElementById("monthYear");
    const searchBox = document.getElementById("searchBox");
    let current = new Date();
    const weekdays = ["日", "月", "火", "水", "木", "金", "土"];

    let events = JSON.parse(localStorage.getItem("events")) || {};
    let recurring = JSON.parse(localStorage.getItem("recurring")) || [];

    function saveData() {
      localStorage.setItem("events", JSON.stringify(events));
      localStorage.setItem("recurring", JSON.stringify(recurring));
    }

    function clearSearch() {
      searchBox.value = "";
      renderCalendar();
    }

    function renderCalendar() {
      const year = current.getFullYear();
      const month = current.getMonth();
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      const startDay = first.getDay();
      const search = searchBox.value.trim().toLowerCase();

      let html = "<table><tr>";
      weekdays.forEach(day => html += `<th>${day}</th>`);
      html += "</tr><tr>";

      let dayCount = 0;
      for (let i = 0; i < startDay; i++) {
        html += "<td></td>";
        dayCount++;
      }

      for (let day = 1; day <= last.getDate(); day++) {
        const dateKey = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();

        let cellClass = "";
        if (date.toDateString() === new Date().toDateString()) cellClass = "today";
        if (dayOfWeek === 0) cellClass += " sunday";
        if (dayOfWeek === 6) cellClass += " saturday";

        html += `<td class="${cellClass}" onclick="addEventPrompt('${dateKey}', ${dayOfWeek})">`;
        html += `<div>${day}</div>`;

        (events[dateKey] || []).forEach((e, i) => {
          if (!search || e.toLowerCase().includes(search)) {
            html += `<div class='event' onclick="editEvent('${dateKey}', ${i}, event)">${e}</div>`;
          }
        });

        recurring.forEach((rec, i) => {
          if (rec.days.includes(dayOfWeek)) {
            if (!search || rec.title.toLowerCase().includes(search)) {
              html += `<div class='event recurring' onclick="editRecurring(${i}, event)">${rec.title}</div>`;
            }
          }
        });

        html += "</td>";
        dayCount++;
        if (dayCount % 7 === 0) html += "</tr><tr>";
      }

      html += "</tr></table>";
      calendar.innerHTML = html;
      monthYear.textContent = `${year}年 ${month+1}月`;
    }

    function addEventPrompt(dateKey, dayOfWeek) {
      const title = prompt("予定を入力:");
      if (!title) return;
      const repeat = confirm("この予定を毎週同じ曜日に繰り返しますか？");
      if (repeat) {
        recurring.push({ title, days: [dayOfWeek] });
      } else {
        if (!events[dateKey]) events[dateKey] = [];
        events[dateKey].push(title);
      }
      saveData();
      renderCalendar();
    }

    function editEvent(dateKey, index, e) {
      e.stopPropagation();
      const currentText = events[dateKey][index];
      const newText = prompt("予定を編集（空欄で削除）:", currentText);
      if (newText === null) return;
      if (newText.trim() === "") {
        events[dateKey].splice(index, 1);
        if (events[dateKey].length === 0) delete events[dateKey];
      } else {
        events[dateKey][index] = newText.trim();
      }
      saveData();
      renderCalendar();
    }

    function editRecurring(index, e) {
      e.stopPropagation();
      const currentText = recurring[index].title;
      const newText = prompt("繰り返し予定を編集（空欄で削除）:", currentText);
      if (newText === null) return;
      if (newText.trim() === "") {
        recurring.splice(index, 1);
      } else {
        recurring[index].title = newText.trim();
      }
      saveData();
      renderCalendar();
    }

    function prevMonth() {
      current.setMonth(current.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      current.setMonth(current.getMonth() + 1);
      renderCalendar();
    }

    renderCalendar();
  </script>
</body>
</html>
